<!-- BEGIN toc -->
<header>
  <h1><%- link_to(url_for(page.type +'/'), site.data.sitemap[page.type].name, {class: `sidebar-link ${is_index() ? ' current' : ''}`}) -%></h1>
</header>
<ul class="menu-root">
  <%_
    const categories = site.data.sitemap[page.type].categories || [];
    
    const pages = site.pages.toArray().filter(p => p.type === page.type && !is_index(p)).sort(function(a, b){
      var ao = a.order || Number.MAX_VALUE;
      var bo = b.order || Number.MAX_VALUE;
      if(ao !== bo)
        return ao - bo;
      return title(a).localeCompare(title(b));
    });
    
    function page_link(p)
    {
      -%><li class="menu-item"><%- link_to(url_for(p.path), title(p), {class: `sidebar-link ${page.path === p.path ? ' current' : ''}`}) %></li><%_
    }
    
    function cate_link(cat, level)
    {
      const catname = Object.getOwnPropertyNames(cat)[0];
      -%><ul class="menu-cat level-<%- level %>"><h<%- level + 1 %> class="menu-cat-name"><%= catname %></h<%- level + 1 %>><%_
      
      let content = cat[catname];
      if (!Array.isArray(content))
        content = [ content ];
        
      for(const child of content)
      {
        if(typeof child === 'number')
          pages.filter(p => Number(p.category) === child).forEach(page_link);
        else
          cate_link(child, level + 1);
      }
      -%></ul><%_
    }
    
    pages.filter(p => Number.isNaN(Number(p.category))).forEach(page_link);
    for(const cat of categories)
      cate_link(cat, 1);
  -%>
</ul>
<!-- END toc -->
